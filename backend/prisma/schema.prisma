generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// MODELO DE USUARIOS
// ==========================================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  role      String   @default("user")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// ==========================================
// MODELO DE INVENTARIO
// ==========================================
model InventarioItem {
  id                Int       @id @default(autoincrement())
  codigo            String?   @unique
  nombre            String
  descripcion       String?
  categoria         String
  unidadMedida      String
  stockActual       Float     @default(0)
  stockMinimo       Float     @default(0)
  stockMaximo       Float?
  costoUnitario     Float     @default(0)
  valorTotal        Float     @default(0)
  estado            String    @default("Disponible")
  ubicacion         String?
  lote              String?
  proveedor         String?
  fechaAdquisicion  DateTime?
  fechaVencimiento  DateTime?
  diasParaVencer    Int?
  observaciones     String?
  activo            Boolean   @default(true)
  ultimoMovimiento  DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  movimientos       MovimientoInventario[]
  alertas           AlertaInventario[]
  recetaDetalles    RecetaDetalle[]
  aplicaciones      AplicacionInsumo[]

  @@map("inventario_items")
}

model MovimientoInventario {
  id                Int      @id @default(autoincrement())
  itemId            Int
  tipo              String
  cantidad          Float
  unidadMedida      String?
  costoUnitario     Float?
  costoTotal        Float?
  fecha             DateTime @default(now())
  razon             String?
  referencia        String?
  destino           String?
  responsable       String?
  createdAt         DateTime @default(now())

  item              InventarioItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("movimientos_inventario")
}

model AlertaInventario {
  id          Int      @id @default(autoincrement())
  itemId      Int
  itemNombre  String?
  tipo        String
  tipoAlerta  String?
  mensaje     String
  prioridad   String   @default("media")
  leida       Boolean  @default(false)
  fecha       DateTime @default(now())
  fechaAlerta DateTime @default(now())
  createdAt   DateTime @default(now())

  item        InventarioItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("alertas_inventario")
}

// ==========================================
// MÓDULO DE CULTIVOS
// ==========================================
model Cultivo {
  id                Int      @id @default(autoincrement())
  nombre            String
  variedad          String?
  descripcion       String?
  diasCiclo         Int?
  costoPorHectarea  Float    @default(0)
  rendimientoEsperado Float?
  activo            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  periodosSiembra   PeriodoSiembra[]
  recetas           Receta[]

  @@map("cultivos")
}

// ==========================================
// MÓDULO DE PARCELAS
// ==========================================
model Parcela {
  id              Int      @id @default(autoincrement())
  codigo          String   @unique
  nombre          String
  superficieHa    Float
  ubicacion       String?
  coordenadas     String?
  tipoSuelo       String?
  sistemaRiego    String?
  estado          String   @default("Activa")
  observaciones   String?
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  periodosSiembra PeriodoSiembra[]
  aplicaciones    AplicacionParcela[]

  @@map("parcelas")
}

// ==========================================
// PERÍODOS DE SIEMBRA (Trazabilidad)
// ==========================================
model PeriodoSiembra {
  id                  Int       @id @default(autoincrement())
  parcelaId           Int
  cultivoId           Int
  codigo              String    @unique
  fechaInicio         DateTime
  fechaFin            DateTime?
  fechaCosechaEsperada DateTime?
  fechaCosechaReal    DateTime?
  hectareasSembradas  Float
  rendimientoEsperado Float?
  rendimientoReal     Float?
  costoTotal          Float     @default(0)
  estado              String    @default("En Curso")
  observaciones       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  parcela             Parcela   @relation(fields: [parcelaId], references: [id])
  cultivo             Cultivo   @relation(fields: [cultivoId], references: [id])
  aplicaciones        AplicacionParcela[]
  actividades         Actividad[]

  @@map("periodos_siembra")
}

// ==========================================
// APLICACIONES POR PARCELA (Historial)
// ==========================================
model AplicacionParcela {
  id                Int       @id @default(autoincrement())
  periodoSiembraId  Int
  parcelaId         Int
  fecha             DateTime  @default(now())
  hectareasAplicadas Float
  tipoAplicacion    String
  costoTotal        Float     @default(0)
  responsable       String?
  observaciones     String?
  createdAt         DateTime  @default(now())

  periodoSiembra    PeriodoSiembra @relation(fields: [periodoSiembraId], references: [id])
  parcela           Parcela        @relation(fields: [parcelaId], references: [id])
  insumos           AplicacionInsumo[]

  @@map("aplicaciones_parcela")
}

// ==========================================
// INSUMOS USADOS EN APLICACIONES
// ==========================================
model AplicacionInsumo {
  id                  Int      @id @default(autoincrement())
  aplicacionId        Int
  insumoId            Int
  cantidad            Float
  unidadMedida        String
  costoUnitario       Float
  costoTotal          Float
  dosisPorHectarea    Float
  createdAt           DateTime @default(now())

  aplicacion          AplicacionParcela @relation(fields: [aplicacionId], references: [id], onDelete: Cascade)
  insumo              InventarioItem    @relation(fields: [insumoId], references: [id])

  @@map("aplicaciones_insumos")
}

// ==========================================
// RECETAS DE APLICACIÓN
// ==========================================
model Receta {
  id          Int      @id @default(autoincrement())
  cultivoId   Int
  nombre      String
  descripcion String?
  etapaCultivo String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cultivo     Cultivo           @relation(fields: [cultivoId], references: [id])
  detalles    RecetaDetalle[]

  @@map("recetas")
}

model RecetaDetalle {
  id                 Int     @id @default(autoincrement())
  recetaId           Int
  insumoId           Int
  dosisPorHectarea   Float
  unidadMedida       String
  orden              Int     @default(1)

  receta             Receta           @relation(fields: [recetaId], references: [id], onDelete: Cascade)
  insumo             InventarioItem   @relation(fields: [insumoId], references: [id])

  @@unique([recetaId, insumoId])
  @@map("receta_detalles")
}

// ==========================================
// ACTIVIDADES PROGRAMADAS
// ==========================================
model Actividad {
  id                Int       @id @default(autoincrement())
  periodoSiembraId  Int
  nombre            String
  tipo              String
  fechaProgramada   DateTime
  fechaRealizada    DateTime?
  estado            String    @default("Pendiente")
  responsable       String?
  costo             Float?
  observaciones     String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  periodoSiembra    PeriodoSiembra @relation(fields: [periodoSiembraId], references: [id])

  @@map("actividades")
}
