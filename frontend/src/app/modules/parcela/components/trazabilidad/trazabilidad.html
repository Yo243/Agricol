<div *ngIf="loading" class="text-center py-12">
  <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent"></div>
  <p class="text-gray-600 mt-4">Cargando trazabilidad...</p>
</div>

<div *ngIf="!loading && trazabilidad">
  <!-- Sin eventos -->
  <div *ngIf="trazabilidad.periodos.length === 0" class="text-center py-12">
    <div class="text-6xl mb-4">ðŸ“‹</div>
    <p class="text-gray-600">No hay eventos de trazabilidad registrados</p>
  </div>

  <!-- Timeline de Eventos -->
  <div *ngIf="trazabilidad.periodos.length > 0" class="space-y-8">
    <div *ngFor="let periodo of trazabilidad.periodos" class="relative">
      <!-- PerÃ­odo Header -->
      <div class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-bold text-gray-800">
              ðŸŒ± {{ periodo.cultivo?.nombre }}
            </h3>
            <p class="text-sm text-gray-600">
              {{ formatearFecha(periodo.fechaInicio) }}
              <span *ngIf="periodo.fechaCosechaReal">
                â†’ {{ formatearFecha(periodo.fechaCosechaReal) }}
              </span>
            </p>
          </div>
          <span [class]="'px-3 py-1 rounded-full text-xs font-semibold ' + (periodo.estado === 'En Curso' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800')">
            {{ periodo.estado }}
          </span>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-3">
          <div>
            <p class="text-xs text-gray-600">HectÃ¡reas</p>
            <p class="text-sm font-semibold">{{ formatearHectareas(periodo.hectareasSembradas) }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-600">Rendimiento</p>
            <p class="text-sm font-semibold">
              {{ periodo.rendimientoReal || periodo.rendimientoEsperado || 0 }} ton
            </p>
          </div>
          <div>
            <p class="text-xs text-gray-600">Aplicaciones</p>
            <p class="text-sm font-semibold">{{ periodo.aplicaciones?.length || 0 }}</p>
          </div>
          <div>
            <p class="text-xs text-gray-600">Costo Total</p>
            <p class="text-sm font-semibold">{{ formatearCosto(periodo.costoTotal) }}</p>
          </div>
        </div>
      </div>

      <!-- Aplicaciones del PerÃ­odo -->
      <div class="ml-8 space-y-4">
        <div *ngFor="let aplicacion of periodo.aplicaciones" class="relative">
          <!-- LÃ­nea de conexiÃ³n -->
          <div class="absolute -left-8 top-0 bottom-0 w-0.5 bg-gray-300"></div>
          
          <!-- Punto de evento -->
          <div class="absolute -left-10 top-3 w-4 h-4 rounded-full bg-blue-500 border-2 border-white"></div>

          <!-- Contenido del evento -->
          <div class="bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start gap-3">
              <div class="text-3xl">
                {{ getEventIcon('AplicaciÃ³n', aplicacion.tipoAplicacion) }}
              </div>
              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h4 class="font-bold text-gray-800">{{ aplicacion.tipoAplicacion }}</h4>
                    <p class="text-sm text-gray-600">{{ formatearFecha(aplicacion.fecha) }}</p>
                  </div>
                  <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
                    {{ formatearHectareas(aplicacion.hectareasAplicadas) }}
                  </span>
                </div>

                <!-- Insumos -->
                <div class="mt-3">
                  <p class="text-sm font-semibold text-gray-700 mb-2">Insumos aplicados:</p>
                  <div class="bg-gray-50 rounded p-3 space-y-2">
                    <div *ngFor="let insumo of aplicacion.insumos" class="flex items-center justify-between text-sm">
                      <div>
                        <span class="font-medium text-gray-800">{{ insumo.insumo?.nombre }}</span>
                        <span class="text-gray-600 ml-2">
                          ({{ insumo.dosisPorHectarea }} {{ insumo.insumo?.unidadMedida }}/ha)
                        </span>
                      </div>
                      <span class="font-semibold text-gray-800">
                        {{ insumo.cantidad }} {{ insumo.insumo?.unidadMedida }}
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Footer -->
                <div class="mt-3 flex items-center justify-between text-sm">
                  <span class="text-gray-600" *ngIf="aplicacion.responsable">
                    ðŸ‘¤ {{ aplicacion.responsable }}
                  </span>
                  <span class="font-bold text-gray-800">
                    Total: {{ formatearCosto(aplicacion.costoTotal) }}
                  </span>
                </div>

                <!-- Observaciones -->
                <div *ngIf="aplicacion.observaciones" class="mt-2 text-sm text-gray-600 italic">
                  ðŸ’¬ {{ aplicacion.observaciones }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje si no hay aplicaciones -->
        <div *ngIf="!periodo.aplicaciones || periodo.aplicaciones.length === 0" 
             class="text-center py-6 text-gray-500 text-sm">
          No hay aplicaciones registradas en este perÃ­odo
        </div>
      </div>
    </div>
  </div>

  <!-- Resumen Final -->
  <div class="mt-8 bg-gray-50 rounded-lg p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-4">ðŸ“Š Resumen de Trazabilidad</h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <p class="text-sm text-gray-600">Total PerÃ­odos</p>
        <p class="text-2xl font-bold text-gray-800">{{ trazabilidad.periodos.length }}</p>
      </div>
      <div>
        <p class="text-sm text-gray-600">Total Aplicaciones</p>
        <p class="text-2xl font-bold text-gray-800">
          {{ trazabilidad.periodos.reduce((sum, p) => sum + (p.aplicaciones?.length || 0), 0) }}
        </p>
      </div>
      <div>
        <p class="text-sm text-gray-600">InversiÃ³n Total</p>
        <p class="text-2xl font-bold text-gray-800">
          {{ formatearCosto(trazabilidad.periodos.reduce((sum, p) => sum + p.costoTotal, 0)) }}
        </p>
      </div>
      <div>
        <p class="text-sm text-gray-600">ProducciÃ³n Total</p>
        <p class="text-2xl font-bold text-gray-800">
          {{ trazabilidad.periodos.reduce((sum, p) => sum + (p.rendimientoReal || 0), 0) }} ton
        </p>
      </div>
    </div>
  </div>
</div>