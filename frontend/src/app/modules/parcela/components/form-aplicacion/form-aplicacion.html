<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <!-- Header -->
    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-800">üíß Registrar Aplicaci√≥n</h2>
        <button (click)="cerrar()" type="button" class="text-gray-500 hover:text-gray-700 text-2xl">
          ‚úï
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loadingData" class="p-12 text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent"></div>
      <p class="text-gray-600 mt-4">Cargando datos...</p>
    </div>

    <!-- Formulario -->
    <form *ngIf="!loadingData" (ngSubmit)="guardar()" class="p-6 space-y-6">
      <!-- Informaci√≥n General -->
      <div class="space-y-4">
        <h3 class="text-lg font-semibold text-gray-700 border-b pb-2">üìã Informaci√≥n General</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Per√≠odo -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Per√≠odo de Siembra <span class="text-red-500">*</span>
            </label>
            <select
              [(ngModel)]="formData.periodoSiembraId"
              name="periodoSiembraId"
              (ngModelChange)="onPeriodoChange()"
              [disabled]="!!periodoId"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              <option value="0">Seleccionar per√≠odo...</option>
              <option *ngFor="let periodo of periodos" [value]="periodo.id">
                {{ periodo.parcela?.nombre }} - {{ periodo.cultivo?.nombre }}
              </option>
            </select>
          </div>

          <!-- Tipo de Aplicaci√≥n -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Tipo de Aplicaci√≥n <span class="text-red-500">*</span>
            </label>
            <select
              [(ngModel)]="formData.tipoAplicacion"
              name="tipoAplicacion"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              <option *ngFor="let tipo of TIPOS_APLICACION" [value]="tipo">{{ tipo }}</option>
            </select>
          </div>

          <!-- Fecha -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Fecha <span class="text-red-500">*</span>
            </label>
            <input
              type="date"
              [(ngModel)]="formData.fecha"
              name="fecha"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>

          <!-- Hect√°reas Aplicadas -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Hect√°reas Aplicadas <span class="text-red-500">*</span>
            </label>
            <input
              type="number"
              [(ngModel)]="formData.hectareasAplicadas"
              name="hectareasAplicadas"
              required
              min="0.01"
              step="0.01"
              placeholder="0.00"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>

          <!-- Responsable -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Responsable
            </label>
            <input
              type="text"
              [(ngModel)]="formData.responsable"
              name="responsable"
              placeholder="Nombre del responsable"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
        </div>
      </div>

      <!-- Insumos -->
      <div class="space-y-4">
        <div class="flex items-center justify-between border-b pb-2">
          <h3 class="text-lg font-semibold text-gray-700">üì¶ Insumos Aplicados</h3>
          <button
            type="button"
            (click)="agregarInsumo()"
            class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
            ‚ûï Agregar Insumo
          </button>
        </div>

        <!-- Selector de Insumo -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Insumo</label>
          <select
            [(ngModel)]="insumoSeleccionado"
            name="insumoSelector"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option [value]="0">Seleccionar...</option>
            <option *ngFor="let insumo of insumos" [value]="insumo.id">
              {{ insumo.nombre }} (Stock: {{ insumo.stockActual }} {{ insumo.unidadMedida }})
            </option>
          </select>
        </div>

        <!-- Tabla de Insumos Seleccionados -->
        <div *ngIf="insumosSeleccionados.length > 0" class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Insumo</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Dosis/ha</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Cantidad Total</th>
                <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Stock</th>
                <th class="px-4 py-2 text-center text-sm font-semibold text-gray-700">Acci√≥n</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let insumo of insumosSeleccionados; let i = index" class="border-t">
                <td class="px-4 py-3">
                  <div>
                    <p class="font-medium text-gray-800">{{ insumo.nombre }}</p>
                    <p class="text-xs text-gray-500">{{ insumo.unidadMedida }}</p>
                  </div>
                </td>
                <td class="px-4 py-3">
                  <input
                    type="number"
                    [(ngModel)]="insumo.dosisPorHectarea"
                    [name]="'dosis_' + i"
                    (ngModelChange)="calcularCantidad(insumo)"
                    min="0.01"
                    step="0.01"
                    class="w-24 px-2 py-1 border border-gray-300 rounded text-sm">
                </td>
                <td class="px-4 py-3">
                  <input
                    type="number"
                    [(ngModel)]="insumo.cantidad"
                    [name]="'cantidad_' + i"
                    min="0.01"
                    step="0.01"
                    class="w-24 px-2 py-1 border border-gray-300 rounded text-sm"
                    [class.border-red-500]="insumo.cantidad > (insumo.stockDisponible || 0)">
                </td>
                <td class="px-4 py-3">
                  <span class="text-sm" [class.text-red-600]="insumo.cantidad > (insumo.stockDisponible || 0)">
                    {{ insumo.stockDisponible }}
                  </span>
                </td>
                <td class="px-4 py-3 text-center">
                  <button
                    type="button"
                    (click)="eliminarInsumo(i)"
                    class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="insumosSeleccionados.length === 0" class="text-center py-8 bg-gray-50 rounded-lg">
          <p class="text-gray-600">No hay insumos agregados</p>
          <p class="text-sm text-gray-500 mt-1">Selecciona un insumo y haz clic en "Agregar Insumo"</p>
        </div>
      </div>

      <!-- Observaciones -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
        <textarea
          [(ngModel)]="formData.observaciones"
          name="observaciones"
          rows="3"
          placeholder="Notas adicionales sobre esta aplicaci√≥n..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"></textarea>
      </div>

      <!-- Botones -->
      <div class="flex gap-3 pt-4 border-t">
        <button
          type="button"
          (click)="cerrar()"
          class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="loading || insumosSeleccionados.length === 0"
          class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
          {{ loading ? 'Registrando...' : 'Registrar Aplicaci√≥n' }}
        </button>
      </div>
    </form>
  </div>
</div>