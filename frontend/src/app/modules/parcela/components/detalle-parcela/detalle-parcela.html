<div class="min-h-screen bg-gray-50 p-4 md:p-6">
  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent"></div>
    <p class="mt-4 text-gray-600">Cargando parcela...</p>
  </div>

  <div *ngIf="!loading && parcela">
    <!-- Header -->
    <div class="mb-6">
      <div class="flex items-center gap-3 mb-4">
        <button 
          routerLink="/parcelas"
          class="text-gray-600 hover:text-gray-800">
          â† Volver
        </button>
      </div>

      <!-- TÃ­tulo y Estado -->
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-6">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">{{ parcela.nombre }}</h1>
            <span [ngClass]="getEstadoColor(parcela.estado)" class="px-3 py-1 rounded-full text-sm font-medium">
              {{ parcela.estado }}
            </span>
          </div>
          <p class="text-gray-600">{{ parcela.codigo }}</p>
        </div>
        <div class="flex gap-2">
          <button 
            (click)="abrirFormPeriodo()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
            <span>ğŸ“…</span>
            <span>Nuevo PerÃ­odo</span>
          </button>
          <button 
            (click)="abrirFormAplicacion()"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
            <span>ğŸ’§</span>
            <span>Registrar AplicaciÃ³n</span>
          </button>
        </div>
      </div>

      <!-- InformaciÃ³n de la Parcela -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center gap-3">
            <div class="text-3xl">ğŸ“</div>
            <div>
              <p class="text-gray-600 text-sm">Superficie</p>
              <p class="text-xl font-bold text-gray-800">{{ formatearHectareas(parcela.superficieHa) }}</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center gap-3">
            <div class="text-3xl">ğŸ“…</div>
            <div>
              <p class="text-gray-600 text-sm">PerÃ­odos Activos</p>
              <p class="text-xl font-bold text-green-600">{{ periodosActivos }}</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center gap-3">
            <div class="text-3xl">ğŸ’§</div>
            <div>
              <p class="text-gray-600 text-sm">Total Aplicaciones</p>
              <p class="text-xl font-bold text-blue-600">{{ totalAplicaciones }}</p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center gap-3">
            <div class="text-3xl">ğŸ’°</div>
            <div>
              <p class="text-gray-600 text-sm">Costo Total</p>
              <p class="text-xl font-bold text-gray-800">{{ formatearCosto(costoTotal) }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalles adicionales -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“‹ InformaciÃ³n Detallada</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div *ngIf="parcela.ubicacion">
            <p class="text-sm text-gray-600">ğŸ“ UbicaciÃ³n</p>
            <p class="font-medium text-gray-800">{{ parcela.ubicacion }}</p>
          </div>
          <div *ngIf="parcela.tipoSuelo">
            <p class="text-sm text-gray-600">ğŸŒ± Tipo de Suelo</p>
            <p class="font-medium text-gray-800">{{ parcela.tipoSuelo }}</p>
          </div>
          <div *ngIf="parcela.sistemaRiego">
            <p class="text-sm text-gray-600">ğŸ’§ Sistema de Riego</p>
            <p class="font-medium text-gray-800">{{ parcela.sistemaRiego }}</p>
          </div>
          <div *ngIf="parcela.coordenadas">
            <p class="text-sm text-gray-600">ğŸ—ºï¸ Coordenadas</p>
            <p class="font-medium text-gray-800">{{ parcela.coordenadas }}</p>
          </div>
        </div>
        <div *ngIf="parcela.observaciones" class="mt-4 pt-4 border-t">
          <p class="text-sm text-gray-600 mb-1">ğŸ“ Observaciones</p>
          <p class="text-gray-800">{{ parcela.observaciones }}</p>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-4">
      <div class="flex gap-2 border-b border-gray-200">
        <button
          (click)="cambiarTab('periodos')"
          [class.border-green-600]="tabActiva === 'periodos'"
          [class.text-green-600]="tabActiva === 'periodos'"
          [class.border-transparent]="tabActiva !== 'periodos'"
          [class.text-gray-600]="tabActiva !== 'periodos'"
          class="px-4 py-2 border-b-2 font-medium transition-colors">
          ğŸ“… PerÃ­odos de Siembra ({{ periodos.length }})
        </button>
        <button
          (click)="cambiarTab('aplicaciones')"
          [class.border-green-600]="tabActiva === 'aplicaciones'"
          [class.text-green-600]="tabActiva === 'aplicaciones'"
          [class.border-transparent]="tabActiva !== 'aplicaciones'"
          [class.text-gray-600]="tabActiva !== 'aplicaciones'"
          class="px-4 py-2 border-b-2 font-medium transition-colors">
          ğŸ’§ Aplicaciones ({{ aplicaciones.length }})
        </button>
        <button
          (click)="cambiarTab('trazabilidad')"
          [class.border-green-600]="tabActiva === 'trazabilidad'"
          [class.text-green-600]="tabActiva === 'trazabilidad'"
          [class.border-transparent]="tabActiva !== 'trazabilidad'"
          [class.text-gray-600]="tabActiva !== 'trazabilidad'"
          class="px-4 py-2 border-b-2 font-medium transition-colors">
          ğŸ“Š Trazabilidad
        </button>
      </div>
    </div>

    <!-- Contenido de Tabs -->
    <div class="bg-white rounded-lg shadow p-6">
      <!-- Tab: PerÃ­odos -->
      <div *ngIf="tabActiva === 'periodos'">
        <div *ngIf="periodos.length === 0" class="text-center py-12">
          <div class="text-6xl mb-4">ğŸ“…</div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay perÃ­odos de siembra</h3>
          <p class="text-gray-500 mb-4">Comienza registrando el primer perÃ­odo</p>
          <button 
            (click)="abrirFormPeriodo()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
            ğŸ“… Nuevo PerÃ­odo
          </button>
        </div>

        <div *ngIf="periodos.length > 0" class="space-y-4">
          <div *ngFor="let periodo of periodos" class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <h4 class="font-semibold text-gray-800">{{ periodo.codigo }}</h4>
                  <span [ngClass]="getEstadoPeriodoColor(periodo.estado)" class="px-2 py-1 rounded-full text-xs font-medium">
                    {{ periodo.estado }}
                  </span>
                </div>
                <p class="text-gray-600">{{ periodo.cultivo?.nombre }} - {{ periodo.cultivo?.variedad }}</p>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-600">HectÃ¡reas</p>
                <p class="font-bold text-gray-800">{{ formatearHectareas(periodo.hectareasSembradas) }}</p>
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
              <div>
                <p class="text-gray-600">Inicio</p>
                <p class="font-medium">{{ formatearFecha(periodo.fechaInicio) }}</p>
              </div>
              <div *ngIf="periodo.fechaCosechaEsperada">
                <p class="text-gray-600">Cosecha Esperada</p>
                <p class="font-medium">{{ formatearFecha(periodo.fechaCosechaEsperada) }}</p>
              </div>
              <div>
                <p class="text-gray-600">Costo Total</p>
                <p class="font-medium">{{ formatearCosto(periodo.costoTotal) }}</p>
              </div>
              <div *ngIf="periodo.rendimientoReal">
                <p class="text-gray-600">Rendimiento</p>
                <p class="font-medium">{{ periodo.rendimientoReal }} ton</p>
              </div>
            </div>

            <div *ngIf="periodo.observaciones" class="mt-3 pt-3 border-t text-sm text-gray-600">
              {{ periodo.observaciones }}
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Aplicaciones -->
      <div *ngIf="tabActiva === 'aplicaciones'">
        <div *ngIf="aplicaciones.length === 0" class="text-center py-12">
          <div class="text-6xl mb-4">ğŸ’§</div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">No hay aplicaciones registradas</h3>
          <p class="text-gray-500 mb-4">Registra la primera aplicaciÃ³n</p>
          <button 
            (click)="abrirFormAplicacion()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
            ğŸ’§ Registrar AplicaciÃ³n
          </button>
        </div>

        <div *ngIf="aplicaciones.length > 0" class="space-y-4">
          <div *ngFor="let aplicacion of aplicaciones" class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="text-2xl">
                    {{ aplicacion.tipoAplicacion === 'FertilizaciÃ³n' ? 'ğŸŒ±' : 
                       aplicacion.tipoAplicacion === 'FumigaciÃ³n' ? 'ğŸ’¨' : 
                       aplicacion.tipoAplicacion === 'Riego' ? 'ğŸ’§' : 'ğŸ“‹' }}
                  </span>
                  <h4 class="font-semibold text-gray-800">{{ aplicacion.tipoAplicacion }}</h4>
                </div>
                <p class="text-sm text-gray-600">{{ formatearFecha(aplicacion.fecha) }}</p>
              </div>
              <div class="text-right">
                <p class="text-sm text-gray-600">Costo</p>
                <p class="font-bold text-gray-800">{{ formatearCosto(aplicacion.costoTotal) }}</p>
              </div>
            </div>

            <div class="mb-3">
              <p class="text-sm text-gray-600 mb-1">HectÃ¡reas aplicadas: {{ formatearHectareas(aplicacion.hectareasAplicadas) }}</p>
              <p *ngIf="aplicacion.responsable" class="text-sm text-gray-600">Responsable: {{ aplicacion.responsable }}</p>
            </div>

            <div *ngIf="aplicacion.insumos && aplicacion.insumos.length > 0" class="space-y-2">
              <p class="text-sm font-medium text-gray-700">Insumos utilizados:</p>
              <div *ngFor="let insumo of aplicacion.insumos" class="flex items-center justify-between bg-gray-50 rounded px-3 py-2 text-sm">
                <span class="text-gray-700">{{ insumo.insumo?.nombre }}</span>
                <span class="font-medium text-gray-800">
                  {{ insumo.cantidad }} {{ insumo.unidadMedida }}
                  <span class="text-gray-500 text-xs ml-2">({{ insumo.dosisPorHectarea }}/ha)</span>
                </span>
              </div>
            </div>

            <div *ngIf="aplicacion.observaciones" class="mt-3 pt-3 border-t text-sm text-gray-600">
              {{ aplicacion.observaciones }}
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Trazabilidad -->
      <div *ngIf="tabActiva === 'trazabilidad'">
        <app-trazabilidad [parcelaId]="parcela.id"></app-trazabilidad>
      </div>
    </div>
  </div>

  <!-- Modales -->
  <app-form-periodo
    *ngIf="mostrarFormPeriodo"
    [parcelaId]="parcela?.id"
    (onClose)="cerrarFormPeriodo()"
    (onSave)="cargarPeriodos()">
  </app-form-periodo>

  <app-form-aplicacion
    *ngIf="mostrarFormAplicacion"
    [parcelaId]="parcela?.id"
    (onClose)="cerrarFormAplicacion()"
    (onSave)="cargarAplicaciones()">
  </app-form-aplicacion>
</div>