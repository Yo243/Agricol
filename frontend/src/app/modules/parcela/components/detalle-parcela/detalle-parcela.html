<div class="container mx-auto px-4 py-6" *ngIf="parcela">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-4 mb-4">
      <a routerLink="/parcelas" class="text-gray-600 hover:text-gray-800 text-2xl">‚Üê</a>
      <div class="flex-1">
        <h1 class="text-3xl font-bold text-gray-800">{{ parcela.nombre }}</h1>
        <p class="text-gray-600">{{ parcela.codigo }}</p>
      </div>
      <span [class]="'px-4 py-2 rounded-full text-sm font-semibold ' + getEstadoColor(parcela.estado)">
        {{ parcela.estado }}
      </span>
    </div>

    <!-- Informaci√≥n de la Parcela -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <p class="text-sm text-gray-600">Superficie</p>
          <p class="text-lg font-bold text-gray-800">{{ formatearHectareas(parcela.superficieHa) }}</p>
        </div>
        <div *ngIf="parcela.ubicacion">
          <p class="text-sm text-gray-600">Ubicaci√≥n</p>
          <p class="text-lg font-bold text-gray-800">{{ parcela.ubicacion }}</p>
        </div>
        <div *ngIf="parcela.tipoSuelo">
          <p class="text-sm text-gray-600">Tipo de Suelo</p>
          <p class="text-lg font-bold text-gray-800">{{ parcela.tipoSuelo }}</p>
        </div>
        <div *ngIf="parcela.sistemaRiego">
          <p class="text-sm text-gray-600">Sistema de Riego</p>
          <p class="text-lg font-bold text-gray-800">{{ parcela.sistemaRiego }}</p>
        </div>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
        <p class="text-gray-600 text-sm">Per√≠odos Activos</p>
        <p class="text-2xl font-bold text-gray-800">{{ periodosActivos }}</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
        <p class="text-gray-600 text-sm">Total Aplicaciones</p>
        <p class="text-2xl font-bold text-gray-800">{{ totalAplicaciones }}</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
        <p class="text-gray-600 text-sm">Costo Total</p>
        <p class="text-2xl font-bold text-gray-800">{{ formatearCosto(costoTotal) }}</p>
      </div>
    </div>

    <!-- Acciones R√°pidas -->
    <div class="flex gap-3 mb-6">
      <button
        (click)="abrirFormPeriodo()"
        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
        <span>üå±</span>
        Iniciar Per√≠odo
      </button>
      <button
        (click)="abrirFormAplicacion()"
        [disabled]="periodosActivos === 0"
        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
        <span>üíß</span>
        Registrar Aplicaci√≥n
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="bg-white rounded-lg shadow">
    <!-- Tab Headers -->
    <div class="border-b border-gray-200">
      <div class="flex">
        <button
          (click)="cambiarTab('periodos')"
          [class]="tabActiva === 'periodos' ? 'border-b-2 border-green-600 text-green-600' : 'text-gray-600 hover:text-gray-800'"
          class="px-6 py-3 font-semibold transition-colors">
          üìÖ Per√≠odos de Siembra
        </button>
        <button
          (click)="cambiarTab('aplicaciones')"
          [class]="tabActiva === 'aplicaciones' ? 'border-b-2 border-green-600 text-green-600' : 'text-gray-600 hover:text-gray-800'"
          class="px-6 py-3 font-semibold transition-colors">
          üíß Aplicaciones
        </button>
        <button
          (click)="cambiarTab('trazabilidad')"
          [class]="tabActiva === 'trazabilidad' ? 'border-b-2 border-green-600 text-green-600' : 'text-gray-600 hover:text-gray-800'"
          class="px-6 py-3 font-semibold transition-colors">
          üîç Trazabilidad
        </button>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="p-6">
      <!-- Per√≠odos Tab -->
      <div *ngIf="tabActiva === 'periodos'">
        <div *ngIf="periodos.length === 0" class="text-center py-12">
          <div class="text-6xl mb-4">üå±</div>
          <p class="text-gray-600">No hay per√≠odos de siembra registrados</p>
        </div>

        <div *ngIf="periodos.length > 0" class="space-y-4">
          <div *ngFor="let periodo of periodos" class="border rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-2">
              <div>
                <h3 class="text-lg font-bold text-gray-800">{{ periodo.cultivo?.nombre }}</h3>
                <p class="text-sm text-gray-600">{{ formatearFecha(periodo.fechaInicio) }}</p>
              </div>
              <span [class]="'px-3 py-1 rounded-full text-xs font-semibold ' + getEstadoPeriodoColor(periodo.estado)">
                {{ periodo.estado }}
              </span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
              <div>
                <p class="text-xs text-gray-600">Hect√°reas</p>
                <p class="font-semibold">{{ formatearHectareas(periodo.hectareasSembradas) }}</p>
              </div>
              <div>
                <p class="text-xs text-gray-600">Rendimiento Esperado</p>
                <p class="font-semibold">{{ periodo.rendimientoEsperado || 0 }} ton</p>
              </div>
              <div *ngIf="periodo.rendimientoReal">
                <p class="text-xs text-gray-600">Rendimiento Real</p>
                <p class="font-semibold">{{ periodo.rendimientoReal }} ton</p>
              </div>
              <div>
                <p class="text-xs text-gray-600">Costo Total</p>
                <p class="font-semibold">{{ formatearCosto(periodo.costoTotal) }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Aplicaciones Tab -->
      <div *ngIf="tabActiva === 'aplicaciones'">
        <div *ngIf="aplicaciones.length === 0" class="text-center py-12">
          <div class="text-6xl mb-4">üíß</div>
          <p class="text-gray-600">No hay aplicaciones registradas</p>
        </div>

        <div *ngIf="aplicaciones.length > 0" class="space-y-4">
          <div *ngFor="let aplicacion of aplicaciones" class="border rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-2">
              <div>
                <h3 class="text-lg font-bold text-gray-800">{{ aplicacion.tipoAplicacion }}</h3>
                <p class="text-sm text-gray-600">{{ formatearFecha(aplicacion.fecha) }}</p>
              </div>
              <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
                {{ formatearHectareas(aplicacion.hectareasAplicadas) }}
              </span>
            </div>
            <div class="mt-4">
              <p class="text-sm font-semibold text-gray-700 mb-2">Insumos aplicados:</p>
              <div class="space-y-1">
                <div *ngFor="let insumo of aplicacion.insumos" class="text-sm text-gray-600">
                  ‚Ä¢ {{ insumo.insumo?.nombre }}: {{ insumo.cantidad }} {{ insumo.insumo?.unidadMedida }}
                </div>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-between">
              <span class="text-sm text-gray-600" *ngIf="aplicacion.responsable">
                üë§ {{ aplicacion.responsable }}
              </span>
              <span class="text-sm font-bold text-gray-800">
                {{ formatearCosto(aplicacion.costoTotal) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Trazabilidad Tab -->
      <div *ngIf="tabActiva === 'trazabilidad'">
        <app-trazabilidad [parcelaId]="parcela.id"></app-trazabilidad>
      </div>
    </div>
  </div>
</div>

<!-- Loading -->
<div *ngIf="loading" class="container mx-auto px-4 py-12 text-center">
  <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-green-500 border-t-transparent"></div>
  <p class="text-gray-600 mt-4">Cargando detalles...</p>
</div>

<!-- Modales -->
<app-form-periodo
  *ngIf="mostrarFormPeriodo"
  [parcelaId]="parcela?.id"
  (onClose)="cerrarFormPeriodo()"
  (onSave)="cerrarFormPeriodo()">
</app-form-periodo>

<app-form-aplicacion
  *ngIf="mostrarFormAplicacion"
  [parcelaId]="parcela?.id"
  (onClose)="cerrarFormAplicacion()"
  (onSave)="cerrarFormAplicacion()">
</app-form-aplicacion>