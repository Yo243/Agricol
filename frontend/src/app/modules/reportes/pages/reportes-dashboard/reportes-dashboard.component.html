<!-- Reportes y Dashboard - Mejorado y Responsive -->

<div class="dashboard-container">

  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <svg class="header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      <div class="header-text">
        <h1 class="page-title">Reportes y Análisis</h1>
        <p class="page-subtitle">Análisis detallado de producción, costos y rendimiento</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-export btn-excel" (click)="exportarExcel()">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <span>Exportar Excel</span>
      </button>
      <button class="btn-export btn-pdf" (click)="exportarPDF()">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
        </svg>
        <span>Exportar PDF</span>
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-card">
    <div class="filters-header">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
      </svg>
      <span>Filtros de Fecha</span>
    </div>
    <div class="filters-content">
      <div class="filter-group">
        <label class="filter-label">Fecha Inicio</label>
        <input type="date" [(ngModel)]="fechaInicio" class="filter-input">
      </div>
      <div class="filter-group">
        <label class="filter-label">Fecha Fin</label>
        <input type="date" [(ngModel)]="fechaFin" class="filter-input">
      </div>
      <div class="filter-actions">
        <button class="btn-filter btn-clear" (click)="limpiarFiltros()">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          <span>Limpiar</span>
        </button>
        <button class="btn-filter btn-apply" (click)="aplicarFiltros()">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <span>Buscar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  @if (loading) {
    <div class="loading-container">
      <svg class="loading-spinner" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="loading-text">Cargando datos...</p>
    </div>
  }

  <!-- Error State -->
  @if (errorMessage && !loading) {
    <div class="error-card">
      <svg class="error-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <p class="error-message">{{ errorMessage }}</p>
      <button class="btn-error-retry" (click)="loadDashboardData()">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span>Reintentar</span>
      </button>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!loading && !errorMessage && dashboardData) {
    <div class="dashboard-content">
      <!-- Stats Grid -->
      @if (dashboardData.resumenGeneral) {
        <div class="stats-grid">
          <div class="stat-card stat-blue">
            <div class="stat-icon-wrapper">
              <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-label">Parcelas Activas</span>
              <span class="stat-value">{{ dashboardData.resumenGeneral.totalParcelas || 0 }}</span>
            </div>
          </div>
          <div class="stat-card stat-green">
            <div class="stat-icon-wrapper">
              <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-label">Hectáreas Totales</span>
              <span class="stat-value">{{ (dashboardData.resumenGeneral.hectareasTotales || 0).toFixed(1) }}</span>
            </div>
          </div>
          <div class="stat-card stat-orange">
            <div class="stat-icon-wrapper">
              <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-label">Cultivos Activos</span>
              <span class="stat-value">{{ dashboardData.resumenGeneral.cultivosActivos || 0 }}</span>
            </div>
          </div>
          <div class="stat-card stat-purple">
            <div class="stat-icon-wrapper">
              <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="stat-content">
              <span class="stat-label">Costo Total Acumulado</span>
              <span class="stat-value stat-value-sm">${{ (dashboardData.resumenGeneral.costoTotalAcumulado || 0).toLocaleString('es-MX') }}</span>
            </div>
          </div>
        </div>
      }
      <!-- Gráficas -->
      @if (chartConsumoOptions.series && chartCostosOptions.series) {
        <div class="charts-container">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Consumo de Insumos</h3>
            </div>
            <div class="chart-wrapper">
              @if (chartConsumoOptions.series) {
                <apx-chart
                  [series]="chartConsumoOptions.series"
                  [chart]="chartConsumoOptions.chart!"
                  [xaxis]="chartConsumoOptions.xaxis!"
                  [yaxis]="chartConsumoOptions.yaxis!"
                  [dataLabels]="chartConsumoOptions.dataLabels!"
                  [title]="chartConsumoOptions.title!"
                  [colors]="chartConsumoOptions.colors!"
                  [plotOptions]="chartConsumoOptions.plotOptions!"
                  [tooltip]="chartConsumoOptions.tooltip!"
                ></apx-chart>
              }
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Evolución de Costos</h3>
            </div>
            <div class="chart-wrapper">
              @if (chartCostosOptions.series) {
                <apx-chart
                  [series]="chartCostosOptions.series"
                  [chart]="chartCostosOptions.chart!"
                  [xaxis]="chartCostosOptions.xaxis!"
                  [yaxis]="chartCostosOptions.yaxis!"
                  [stroke]="chartCostosOptions.stroke!"
                  [dataLabels]="chartCostosOptions.dataLabels!"
                  [title]="chartCostosOptions.title!"
                  [colors]="chartCostosOptions.colors!"
                  [fill]="chartCostosOptions.fill!"
                  [tooltip]="chartCostosOptions.tooltip!"
                ></apx-chart>
              }
            </div>
          </div>
        </div>
      }
      <!-- Períodos de Siembra Activos -->
      @if (dashboardData.periodosActivos) {
        <div class="section-card">
          <div class="section-header">
            <div class="section-title-wrapper">
              <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
              </svg>
              <h2 class="section-title">Períodos de Siembra Activos</h2>
            </div>
            <button class="btn-section-action" routerLink="/periodos-siembra/nuevo">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              <span>Nuevo Período</span>
            </button>
          </div>
          <!-- Empty State -->
          @if (!dashboardData.periodosActivos || dashboardData.periodosActivos.length === 0) {
            <div class="empty-state">
              <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
              </svg>
              <h3 class="empty-title">No hay períodos de siembra activos</h3>
              <p class="empty-description">Inicia un nuevo período para comenzar a dar seguimiento a tus cultivos</p>
              <button class="btn-empty-action" routerLink="/periodos-siembra/nuevo">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                <span>Crear Primer Período</span>
              </button>
            </div>
          }
          <!-- Grid de Períodos -->
          @if (dashboardData.periodosActivos && dashboardData.periodosActivos.length > 0) {
            <div class="periodos-grid">
              @for (periodo of dashboardData.periodosActivos; track periodo) {
                <div class="periodo-card">
                  <div class="periodo-header">
                    <h3 class="periodo-title">{{ periodo.cultivo }}</h3>
                    <span class="periodo-badge">{{ periodo.estado }}</span>
                  </div>
                  <div class="periodo-info">
                    <div class="info-row">
                      <span class="info-label">Parcela:</span>
                      <span class="info-value">{{ periodo.parcela }}</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Hectáreas:</span>
                      <span class="info-value">{{ periodo.hectareas }} ha</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Fecha Siembra:</span>
                      <span class="info-value">{{ periodo.fechaInicio | date: 'dd/MM/yyyy' }}</span>
                    </div>
                    <div class="info-row">
                      <span class="info-label">Cosecha Esperada:</span>
                      <span class="info-value">{{ periodo.fechaCosechaEsperada | date: 'dd/MM/yyyy' }}</span>
                    </div>
                  </div>
                  <div class="periodo-progress">
                    <div class="progress-header">
                      <span class="progress-label">Progreso</span>
                      <span class="progress-value">{{ periodo.progreso }}%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="periodo.progreso"></div>
                    </div>
                  </div>
                  <button class="btn-periodo-detail" [routerLink]="['/periodos-siembra', periodo.id]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    <span>Ver Detalle</span>
                  </button>
                </div>
              }
            </div>
          }
        </div>
      }
      <!-- Alertas Recientes -->
      @if (dashboardData.alertas && dashboardData.alertas.length > 0) {
        <div class="section-card">
          <div class="section-header">
            <div class="section-title-wrapper">
              <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
              <h2 class="section-title">Alertas Recientes</h2>
            </div>
          </div>
          <div class="alertas-list">
            @for (alerta of dashboardData.alertas; track alerta) {
              <div
                class="alerta-item"
                [class.alerta-critica]="alerta.prioridad === 'alta'"
                [class.alerta-media]="alerta.prioridad === 'media'">
                <div class="alerta-icon-wrapper">
                  @if (alerta.tipo === 'stock') {
                    <svg class="alerta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                  }
                  @if (alerta.tipo === 'vencimiento') {
                    <svg class="alerta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  }
                  @if (alerta.tipo === 'aplicacion') {
                    <svg class="alerta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                  }
                </div>
                <div class="alerta-content">
                  <p class="alerta-message">{{ alerta.mensaje }}</p>
                  <span class="alerta-date">{{ alerta.fecha | date: 'dd/MM/yyyy HH:mm' }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }

</div>